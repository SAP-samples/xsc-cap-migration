# HDB Virtual Table Migration from XS to CAP
SAP HANA Virtual Tables are a feature of SAP HANA Smart Data Access (SDA) that allows you to access remote data sources as if they were local tables. These tables do not store data locally but instead provide a virtualized view of the data in the remote source. While this is a powerful feature for integrating data from multiple systems, it introduces challenges when migrating from the XS (Extended Services) environment to SAP HANA Cloud.

Why Virtual Tables Cannot Be Migrated Directly

1. **Dependency on Remote Sources**: Virtual tables rely on a remote source configuration that defines the connection to the external database. These configurations are environment-specific and cannot be directly transferred between XS and HANA Cloud without reconfiguring the remote source in the target environment.

2. **No Physical Data**: Since virtual tables do not store data locally, there is no data to migrate. The virtual table is essentially a metadata object that references the remote source. Migrating the virtual table requires re-establishing the remote source and recreating the virtual table definition in the target environment.

3. **Security and Connectivity**: The remote source in the XS environment may use specific credentials, network configurations, or security settings that are not directly transferable to HANA Cloud. These need to be reconfigured in the new environment.

4. **CAP Model Migration**: When migrating to a CAP (Cloud Application Programming) model, virtual tables are not directly supported. Instead, you need to create proxy entities in the CAP model to represent the virtual tables. This involves defining the entity with the `@cds.persistence.exists` annotation and mapping it to the virtual table.

There are two types of virtual tables in SAP HANA: Design-time virtual tables and Runtime virtual tables. Here's a clearer and more detailed explanation:

1. **Design-Time Virtual Tables:**
   These virtual tables are defined using `.hdbvirtualtable` files in the development environment and are a part of the application’s design-time artifacts and are deployed along with the application. When migrating to a new environment, such as SAP HANA Cloud, these tables require the creation of proxy entities in the target system. Proxy entities are defined in the CAP (Cloud Application Programming) model using the `@cds.persistence.exists` annotation. This annotation indicates that the entity already exists in the database and maps it to the corresponding virtual table.

2. **Runtime Virtual Tables:**
   These virtual tables are created dynamically at runtime using SQL statements in the source database and Unlike design-time virtual tables, runtime virtual tables are not part of the application’s design-time artifacts and are not automatically included in the migration process. When migrating to a new environment, such as SAP HANA Cloud, these runtime virtual tables must be manually recreated in the target database.

The XS Classic environment will only have runtime virtual tables, while the XS Advanced environment might have both design-time and runtime virtual tables. The details of these virtual tables, along with any dependent artifacts (e.g., views, procedures, or functions that rely on these tables), are typically provided in a migration report at the end of the migration. This report helps identify the tables and their dependencies to ensure they are correctly recreated in the target environment.

## XSC to CAP Migration Path
In this example, we use an external database as the source system and an on-premise SAP HANA XS Classic (XSC) system hosting the virtual table created via a remote source. The virtual table setup will then be migrated to a CAP project deployed on SAP HANA Cloud.

### Step 1: Set Up the External Source Database
Create a table in the external source database, define its schema, and populate it with sample data. This example demonstrates the process using SAP Hana.
   ```
   CREATE COLUMN TABLE "customers" (
    "customer_id" NVARCHAR(10) PRIMARY KEY,
    "customer_name" NVARCHAR(100),
    "email" NVARCHAR(100),
    "country" NVARCHAR(50)
   );

   CREATE COLUMN TABLE "products" (
    "product_id" NVARCHAR(10) PRIMARY KEY,
    "product_name" NVARCHAR(100),
    "unit_price" DECIMAL(10,2),
    "category" NVARCHAR(50)
   );

   CREATE COLUMN TABLE "orders" (
    "order_id" NVARCHAR(20) PRIMARY KEY,
    "customer_id" NVARCHAR(10),
    "order_date" DATE,
    "status" NVARCHAR(20),
    FOREIGN KEY ("customer_id") REFERENCES "customers"("customer_id")
   );

   CREATE COLUMN TABLE "order_items" (
    "order_item_id" INTEGER GENERATED BY DEFAULT AS IDENTITY,
    "order_id" NVARCHAR(20),
    "product_id" NVARCHAR(10),
    "quantity" INTEGER,
    FOREIGN KEY ("order_id") REFERENCES "orders"("order_id"),
    FOREIGN KEY ("product_id") REFERENCES "products"("product_id"),
    PRIMARY KEY ("order_item_id")
   );

   CREATE COLUMN TABLE "test.vt.TABLE::DEMO" (
    ID         INT PRIMARY KEY,
    NAME        NVARCHAR(100),
    CREATED_AT  DATE,
    AMOUNT      DECIMAL(10, 2)
   );

   INSERT INTO "test.vt.TABLE::DEMO" VALUES (1, 'Alice', DATE '2025-05-25', 100.50);
   INSERT INTO "test.vt.TABLE::DEMO" VALUES (2, 'Bob', DATE '2025-05-30', 200.00);
   INSERT INTO "test.vt.TABLE::DEMO" VALUES (3, 'Charlie', DATE '2025-06-04', 300.75);

   -- Insert Customers
   INSERT INTO "customers" VALUES ('C001', 'Alice Johnson', 'alice@example.com', 'USA');
   INSERT INTO "customers" VALUES ('C002', 'Bob Smith', 'bob@example.com', 'Germany');

   -- Insert Products
   INSERT INTO "products" VALUES ('P001', 'Laptop', 1200.00, 'Electronics');
   INSERT INTO "products" VALUES ('P002', 'Mouse', 25.00, 'Accessories');

   -- Insert Orders
   INSERT INTO "orders" VALUES ('O1001', 'C001', '2025-05-10', 'Shipped');
   INSERT INTO "orders" VALUES ('O1002', 'C002', '2025-03-03', 'Processing');

   -- Insert Order Items
   INSERT INTO "order_items" ("order_id", "product_id", "quantity") VALUES ('O1001', 'P001', 1);
   INSERT INTO "order_items" ("order_id", "product_id", "quantity") VALUES ('O1001', 'P002', 2);
   INSERT INTO "order_items" ("order_id", "product_id", "quantity") VALUES ('O1002', 'P002', 1);
   ```

### Step 2: Configure the Remote Source in the XSA System
- In the XSC system, create a remote source to connect to the external database using the SQL command. You can refer the [Supported Remote Sources](https://help.sap.com/docs/hana-cloud-database/sap-hana-cloud-sap-hana-database-data-access-guide/supported-remote-sources) for the correct syntax.
- Ensure the user specified in the remote source has the necessary privileges to access the schema and table in the external source database.

### Step 3: Create an XSC Package in the XSC System
- In the XSC system, create a schema using the following command:
  ```
  CREATE SCHEMA <schema name> OWNED BY SYSTEM;
  ```
- Grant the necessary permissions to the created schema
  ```
  GRANT SELECT, INSERT, UPDATE, DELETE, EXECUTE ON SCHEMA <schema name> TO _SYS_REPO WITH GRANT OPTION;
  ```
- Grant permission to create virtual tables on the remote source
  ```
  GRANT CREATE VIRTUAL TABLE ON REMOTE SOURCE "<remote_source_name>" TO _SYS_REPO;
  ```
- Create a package in the XSC system and define a runtime virtual table within the package. For example,
  ```
  CREATE VIRTUAL TABLE "<schema name>"."<PackageName>::<VirtualtabelName>" AT "<remote_source_name>"."<NULL>"."<ExternalSchema>"."products"
  ```
- The created virtual table can be utilized in other artifacts, such as procedures, functions, calculation views, and so on. Once these artifacts are defined, ensure they are activated in the XSC system.

### Step 4: Migrate the XSC Package to CAP
- Use the SAP HANA Application Migration Assistant extension to migrate this XSC package to CAP.
- The extension will generate a CAP project along with a `report.html` file containing details of the virtual tables and their dependencies. Since it is an XSC system, only runtime virtual tables will be present.
- Before deploying the application to Hana Cloud, ensure that the remote source and its configurations are also created in the target Hana Cloud database. You can refer the [document](https://community.sap.com/t5/technology-blog-posts-by-sap/create-virtual-table-in-hdi/ba-p/13577953) for guidance.